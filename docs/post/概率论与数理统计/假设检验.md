创建于 2023-07-05<br>
关键词: 假设检验, A/B测试.

## 什么是假设检验

在总体的分布函数完全未知或只知其形式、但不知其参数的情况，为了推断总体的某些未知特性，提出某些关于总体的假设。我们要根据样本对所提出的假设做出是拒绝还是接受的决策，假设检验就是做出这一决策的过程。

## 单个总体参数的假设检验



## 两个总体参数的假设检验



## **A/B测试原理简介**

A/B测试的核心就是**假设检验**。A/B测试中的假设检验就是检验实验组与对照组的某个指标是否有显著差异。

既然是假设检验，那么就是先假设，再收集数据，最后根据收集的数据来做检验。

假设一般成对出现，分为**零假设**和**备择假设**。

在A/B测试中，零假设是：实验组与对照组的某个指标相同，无显著差异；备择假设是：实验组与对照组的某个指标不同，有显著差异。

举个例子，我们优化了某算法，想提高页面的点击率，针对这个场景的A/B测试，零假设是： 新算法与老算法的页面点击率无明显差异；备择假设是： 新算法与老算法的页面点击率有显著差异。

一般来说，我们是通过具体的检验指标类型来找寻相应的检验方法。检验指标类型有**均值指标**、**标准差指标**和**比例指标**，分别对应假设检验中对总体的均值、标准差和比例的检验。如果是想要验证某个总体的均值、标准差或比例和一个常数的大小关系，则称为单总体的假设检验(或单样本的假设检验)；如果是想要验证两个总体的均值、标准差或比例之间的大小关系，则称为双总体的假设检验(或双样本的假设检验)。比如，上述新老算法优化页面点击率(点击率属于比例指标)的A/B测试实验属于双样本(双总体)比例假设检验。

由于A/B测试实验本身需要实验组和对照组之间进行对比，因此都属于双样本(双总体)假设检验。

确定了检验指标之后就可以根据其它条件(如总体方差是否可依据经验视为已知等)确定检验方法，然后确定实验所需最小样本量计算方式，以及估算实验周期等。

## **A/B测试详细流程**

假设检验，大体上可以分为3步，即提出假设、收集数据和数据检验。应用到具体的A/B测试场景中从假设到检验根据实际情况会有一个较长的实验流程，大部分情况下这个流程可以用下图表示清楚。

![image-20230705151716666](img/image-20230705151716666.png)

**选取指标**：在做A/B测试之前，我们一定要清楚，我们实验的目标是什么。并落地到具体的几个指标上，这几个指标对于度量实验结果，有非常明显的帮助。但是，指标也要分层级，唯一一个核心指标加上多个观察指标。

核心指标用来度量我们这次实验的效果，以及计算相应的样本量，这个是假设检验要检验的指标；观察指标则用来度量该实验对其他数据的影响，其它指标不是这次实验要检验的主要对象，我们可以通过观察来感觉其它指标是否也有明显的变化，当样本量及其它条件满足的时候也可以对其它指标进行检验，当条件不满足的时候可以重新设计实验来检验其它指标以验证猜想。

**建立假设**：建立零假设和备择假设。零假设是实验组与对照组没有显著差异，简单讲就是在实验组中所做的改变并没有观察到明显的效果；备择假设是实验组与对照组有显著差异，简单讲就是实验组中所做的改变有被观察到有明显的效果。

**选取实验单位**：绝大部分情况下都是使用用户来作为实验单位，即一个用户就是一个样本，用户分流后保证不会出现一些用户同时出现在实验组和对照组。但是有时候也要具体情况具体分析。

**计算样本量**：计算实验所需要的最小样本量是多少。由中心极限定理易知，样本量固然是越大越好，然而实际情况中样本的采集会有很多限制，比如在线广告投放的A/B测试，所需样本量太大会导致实验成本太高，这个时候就需要一个合适的样本量的实验，保证实验成本是可以接受的。降低实验成本的方法可以考虑：使用不同的检验指标、使用不同的检验方法和其它一些可以降低广告花费的方法。



## A/B测试代码实践

由于A/B测试都属于双总体(双样本)假设检验，而根据检验指标的不同双总体(双样本)假设检验可以分为三种：双总体(双样本)均值假设检验、双总体(双样本)标准差假设检验和双总体(双样本)比例假设检验。后续分别对这三种情况进行代码实践。

### 双总体(双样本)均值假设检验



### 双总体(双样本)标准差假设检验



### 双总体(双样本)比例假设检验

**案例**：某公司原来的购买转化率是30%左右，现在想通过把其网页上的“购买”按钮加大一倍，使购买转化率提升到33%以上。

可以看到这里的对比指标是购买转化率，因此这里适用双总体(双样本)比例检验。

**原假设**：对照组的购买转化率与实验组的购买转化率无显著差异；

**备择假设**：对照组的购买转化率与实验组的购买转化率有显著差异。

#### 计算最小样本量

假设我想要达到的功效为80%，显著性水平为5%，通过`statsmodels`计算最小样本量的步骤如下：

首先计算出我们想要达到的效应量，即购买转化率提升到33%对应的效应量是多少，然后再通过效应量，功效，显著性水平计算出每组所需的最小样本量。

```python
## 代码位置：https://github.com/xhqing/statistics/blob/main/ab_test/sample_size.py

from statsmodels.stats.proportion import proportion_effectsize
from statsmodels.stats.power import zt_ind_solve_power

effect_size = proportion_effectsize(prop1=0.3, prop2=0.33, method='normal')
sample_size = zt_ind_solve_power(effect_size=effect_size, nobs1=None, alpha=0.05, power=0.8, ratio=1.0, alternative='two-sided')

print(round(sample_size))
```

`zt_ind_solve_power`函数里的参数`ratio=1`表示实验组和对照组的样本量相同，`alternative='two-sided'`表示是双尾检验。 

计算结果是：每组至少需要3762个样本。

#### 计算p值

假设两种方案各有5000个用户参与测试，原方案有1545个用户完成转化，优化方案有1670个用户完成转化。用`statsmodels`计算p值：

```python
## 代码位置：https://github.com/xhqing/statistics/blob/main/ab_test/p_value.py
from statsmodels.stats.proportion import proportions_ztest
z_score, p_value = proportions_ztest(count=[1545,1670], nobs=[5000,5000], value=None, alternative='two-sided')
print(p_value)
```

`proportions_ztest`函数里的count表示对照组和实验组完成转化的人数，`nobs`表示各组观测人数(样本数)。

计算出的p值约为：0.007，p<α=0.05，结果是显著的。

#### 计算置信区间

```python
## 代码位置：https://github.com/xhqing/statistics/blob/main/ab_test/confidence_interval.py

p1 = 1545/5000
p2 = 1670/5000
n1 = n2 = 5000
p = (n1*p1+n2*p2)/(n1+n2)

from scipy.stats import norm

## 计算临界值
z_critical = norm.ppf(0.975) 

## 计算边际误差
margin = z_critical*(p*(1-p)*(1/n1+1/n2))**0.5 

## 计算置信区间下限
lower = p - margin
## 计算置信区间上限
upper = p + margin

print((round(lower,2), round(upper,2))
```

计算得出置信区间是(0.3, 0.34)。

#### 实验报告

1. 描述统计

对照组样本：5000个用户，其中有1545人完成购买转化，占比p1=0.309。

实验组样本：5000个用户，其中有1670人完成购买转化。占比p2=0.334。

2. 推断统计

（1）假设检验

原假设：实验组的购买转化率p2-对照组的购买转化率p1=0

备择假设：实验组的购买转化率p2-对照组的购买转化率p1≠0

检验类型：双总体(双样本)比例假设检验

样本量：对照组5000，实验组5000

抽样分布类型：p1-p2近似正态分布

检验方向：双尾

显著性水平α：0.05

检验统计量的值：-2.68

p值：0.007

结论：p<α，拒绝原假设，实验组的购买转化率与对照组的购买转化率之间有显著差异。

（2）置信区间

置信度：0.95

置信度对应的检验统计量的值：-1.96, 1.96

置信区间：(0.3, 0.34)

3. 效应量

效应量的类型：Cohen's h

效应量的值：0.086

对效应量的解释：效应量低于0.2，属于小效应量，虽然实验组的购买转化率与对照组的购买转化率之间的差异具有显著性，但差异不大。

最终结论：实验组的购买转化率与对照组的购买转化率之间有显著差异，虽然差异不大，但达到优化目标。

